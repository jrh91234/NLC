<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NLC MRP System V.7.4 (Auto Detect)</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- Font for Printing -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .smooth-scroll { -webkit-overflow-scrolling: touch; }
        @media print {
            .no-print { display: none !important; }
            .print-break-inside-avoid { break-inside: avoid; }
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (PASSWORD CONFIG)
        // ==========================================
        const ADMIN_PASS = "1111"; 
        const USER_PASS = "2222";
        
        // Storage Keys
        const STORAGE_KEY_CONFIG = "NLC_MRP_CONFIG_V7"; 
        // ==========================================

        const translations = {
            th: {
                appTitle: "NLC MRP System",
                subtitle: "V.7.4 Auto Detect",
                loginTitle: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô",
                passwordPlaceholder: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...",
                loginButton: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
                loginError: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!",
                roleAdmin: "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)",
                roleUser: "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (User)",
                logout: "‡∏≠‡∏≠‡∏Å",
                
                // Cloud Sync
                cloudSection: "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets (Cloud)",
                cloudHint: "‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏≠‡∏≤‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå: ‡πÄ‡∏°‡∏ô‡∏π File > Share > Publish to web > ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å CSV > ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå",
                pasteLink: "‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Publish to web (CSV) ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...",
                saveCloud: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠",
                syncing: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud...",
                syncSuccess: "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                syncError: "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ",
                usingCloud: "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets",
                usingLocal: "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (Local)",
                
                // Steps
                step1: "1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ BOM",
                step2: "2. ‡πÉ‡∏™‡πà Order",
                step3: "3. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•",
                
                // General
                uploadTitle: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î BOM (‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå)",
                configTitle: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå",
                dropZone: "‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á",
                instruction: "Admin: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'",
                reload: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà",
                next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
                inputOrderTitle: "‡∏£‡∏∞‡∏ö‡∏∏ Order ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï",
                importOrderTitle: "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå (Excel/CSV)",
                importOrderHint: "‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .xlsx, .csv (A=Model, B=Qty)",
                or: "‡∏´‡∏£‡∏∑‡∏≠",
                copyPasteLabel: "‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏ß‡∏≤‡∏á (Model & Qty)",
                placeholder: "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:\nQWKDE3100EZ12  50\nQWKPE3100EZ18  20",
                inputHint: "* ‡πÉ‡∏ä‡πâ Tab, Comma ‡∏´‡∏£‡∏∑‡∏≠ Space ‡πÅ‡∏ö‡πà‡∏á",
                itemList: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                clear: "‡∏•‡πâ‡∏≤‡∏á",
                noData: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                back: "‡∏Å‡∏•‡∏±‡∏ö",
                calculate: "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì",
                resultTitle: "‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î Material",
                orderSummary: "Order: {models} ‡∏£‡∏∏‡πà‡∏ô, ‡∏£‡∏ß‡∏°: {units} ‡∏ï‡∏±‡∏ß",
                showAll: "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
                onlyNew: "New",
                onlyReuse: "Reuse",
                print: "‡∏û‡∏¥‡∏°‡∏û‡πå",
                export: "Excel",
                missingModel: "‡πÑ‡∏°‡πà‡∏û‡∏ö Model",
                colNo: "#",
                colPartNo: "Part No.",
                colDesc: "Description",
                colLevel: "Lvl",
                colStatus: "Stat",
                colQty: "Qty",
                modalTitle: "‡πÑ‡∏°‡πà‡∏û‡∏ö Model... ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á?",
                modalDesc: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡πÅ‡∏ï‡πà‡πÄ‡∏à‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á:",
                modalOriginal: "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏°‡∏≤",
                modalCandidate: "‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á",
                btnSkip: "‡∏Ç‡πâ‡∏≤‡∏°",
                btnUse: "‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ",
                alertPartNo: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Part Number (‡∏õ‡∏∏‡πà‡∏° P#)",
                alertModel: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Model ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏õ‡∏∏‡πà‡∏° Model)",
                calcError: "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
                sortBy: "‡πÄ‡∏£‡∏µ‡∏¢‡∏á:",
                sortStructure: "‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á",
                sortQty: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô",
                breakdownTitle: "‡πÉ‡∏ä‡πâ: {partNo}",
                legendRed: "‡πÅ‡∏î‡∏á = ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ (0)",
                legendNormal: "‡∏õ‡∏Å‡∏ï‡∏¥ = ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤",
                readError: "‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ",
                saveConfig: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤"
            },
            en: {
                appTitle: "NLC MRP System",
                subtitle: "V.7.4 Auto Detect",
                loginTitle: "Authentication",
                passwordPlaceholder: "Enter Password...",
                loginButton: "Login",
                loginError: "Incorrect Passcode!",
                roleAdmin: "Administrator",
                roleUser: "Standard User",
                logout: "Logout",
                cloudSection: "Google Sheets Connection (Cloud)",
                cloudHint: "How to: File > Share > Publish to web > Select CSV > Publish > Copy Link",
                pasteLink: "Paste Publish to web (CSV) Link here...",
                saveCloud: "Save & Connect",
                syncing: "Syncing from Cloud...",
                syncSuccess: "Synced with Google Sheets!",
                syncError: "Sync Failed: ",
                usingCloud: "Using Data from Google Sheets",
                usingLocal: "Using Offline Data (Local)",
                step1: "1. Manage BOM",
                step2: "2. Input Order",
                step3: "3. Result",
                uploadTitle: "Upload BOM (File)",
                configTitle: "Column Config",
                dropZone: "Tap to Upload CSV/TXT",
                instruction: "Admin: System auto-detects headers. Verify and click 'Next'.",
                reload: "Reset",
                next: "Next",
                inputOrderTitle: "Input Orders",
                importOrderTitle: "Import File (Excel/CSV)",
                importOrderHint: ".xlsx, .csv (A=Model, B=Qty)",
                or: "or",
                copyPasteLabel: "Type / Paste (Model & Qty)",
                placeholder: "Ex:\nQWKDE3100EZ12  50\nQWKPE3100EZ18  20",
                inputHint: "* Tab, Comma, or Space separated",
                itemList: "List",
                clear: "Clear",
                noData: "No Data",
                back: "Back",
                calculate: "Calculate",
                resultTitle: "Material Summary",
                orderSummary: "Order: {models}, Units: {units}",
                showAll: "All",
                onlyNew: "New",
                onlyReuse: "Reuse",
                print: "Print",
                export: "Excel",
                missingModel: "Missing",
                colNo: "#",
                colPartNo: "Part No.",
                colDesc: "Description",
                colLevel: "Lvl",
                colStatus: "Stat",
                colQty: "Qty",
                modalTitle: "Did you mean?",
                modalDesc: "Exact match not found, closest match:",
                modalOriginal: "Input",
                modalCandidate: "Match",
                btnSkip: "Skip",
                btnUse: "Use",
                alertPartNo: "Please select Part Number column (P#).",
                alertModel: "Select at least one Model column.",
                calcError: "Error",
                sortBy: "Sort:",
                sortStructure: "Struct",
                sortQty: "Qty",
                breakdownTitle: "Usage: {partNo}",
                legendRed: "Red = 0 usage",
                legendNormal: "Normal = Active",
                readError: "Read Error: ",
                saveConfig: "Save Config"
            }
        };

        const Icons = {
            Database: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"></path></svg>,
            FileSpreadsheet: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            RefreshCw: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Calculator: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Printer: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Globe: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>,
            Sort: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="21" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="3" y2="18"></line></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            Save: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
            Trash: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            Shield: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>,
            Cloud: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>,
            Link: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
        };

        const App = () => {
          // --- Auth State ---
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [userRole, setUserRole] = useState(null); 
          const [inputPassword, setInputPassword] = useState("");
          const [loginError, setLoginError] = useState(false);

          // --- App State ---
          const [activeTab, setActiveTab] = useState('bom');
          const [lang, setLang] = useState('en'); 
          const t = (key) => translations[lang][key] || key;
          
          // --- BOM State ---
          const [bomData, setBomData] = useState([]); 
          const [bomHeaders, setBomHeaders] = useState([]);
          const [headerRowIndex, setHeaderRowIndex] = useState(-1);
          const [partNoColIndex, setPartNoColIndex] = useState(-1);
          const [partNameColIndex, setPartNameColIndex] = useState(-1);
          const [statusColIndex, setStatusColIndex] = useState(-1);
          const [levelColIndex, setLevelColIndex] = useState(-1); 
          const [modelColumns, setModelColumns] = useState({}); 
          const [isBomConfigured, setIsBomConfigured] = useState(false);
          const [fileName, setFileName] = useState("");
          
          // --- Cloud State ---
          const [cloudUrl, setCloudUrl] = useState("");
          const [isSyncing, setIsSyncing] = useState(false);
          const [isUsingCloud, setIsUsingCloud] = useState(false);

          // --- Order State ---
          const [orders, setOrders] = useState([]);
          const [orderText, setOrderText] = useState(""); 
          
          // --- Result & Resolve State ---
          const [calculationResult, setCalculationResult] = useState(null);
          const [missingModels, setMissingModels] = useState([]);
          const [filterType, setFilterType] = useState('all');
          const [sortType, setSortType] = useState('structure'); 
          const [showResolveModal, setShowResolveModal] = useState(false);
          const [resolveQueue, setResolveQueue] = useState([]); 
          const [verifiedOrders, setVerifiedOrders] = useState([]);
          const [tempMissing, setTempMissing] = useState([]);
          const [breakdownItem, setBreakdownItem] = useState(null); 

          // --- CORE FUNCTIONS (Moved Up to Fix Scope Issues) ---
          const handleLogin = (e) => {
              e.preventDefault();
              if (inputPassword === ADMIN_PASS) { setIsAuthenticated(true); setUserRole('admin'); setLoginError(false); }
              else if (inputPassword === USER_PASS) { setIsAuthenticated(true); setUserRole('user'); setLoginError(false); }
              else { setLoginError(true); setInputPassword(""); }
          };

          const handleLogout = () => {
              setIsAuthenticated(false);
              setUserRole(null);
              setInputPassword("");
              setOrders([]);
              setOrderText("");
              setCalculationResult(null);
              setActiveTab('bom');
          };

          const selectHeaderRow = (index, dataRef = bomData) => {
            setHeaderRowIndex(index);
            const headers = dataRef[index];
            setBomHeaders(headers);
            let pNoIndex = -1, pNameIndex = -1, sIndex = -1, lIndex = -1, models = {};
            headers.forEach((h, i) => {
              const lowerH = h.toLowerCase().replace(/[\n\r]/g, ''); 
              if (pNoIndex === -1 && (lowerH.includes('part number') || lowerH.includes('part no') || lowerH === 'p/n')) pNoIndex = i;
              else if (pNameIndex === -1 && (lowerH.includes('part name') || lowerH.includes('description') || lowerH.includes('desc'))) pNameIndex = i;
              else if (sIndex === -1 && (lowerH.includes('new') && lowerH.includes('reuse') || lowerH.includes('status') || lowerH === 'type')) sIndex = i;
              else if (lIndex === -1 && (lowerH === 'level' || lowerH === 'lvl')) lIndex = i;
              else {
                const ignoreKeywords = ['level', 'unit', 'cost', 'remark', 'note', 'qty', 'total', 'price'];
                const isKeyword = ignoreKeywords.some(kw => lowerH.includes(kw));
                let hasNumberData = false;
                for(let r = index + 1; r < Math.min(index + 6, dataRef.length); r++) { if (!isNaN(parseFloat(dataRef[r][i]))) { hasNumberData = true; break; } }
                if (h.trim().length > 0 && !isKeyword) models[i] = h;
              }
            });
            setPartNoColIndex(pNoIndex); setPartNameColIndex(pNameIndex); setStatusColIndex(sIndex); setLevelColIndex(lIndex); setModelColumns(models);
          };

          const fetchBOMFromCloud = async (url, config = null) => {
              if (!url) return;
              setIsSyncing(true);
              try {
                  // Basic URL cleanup
                  let fetchUrl = url.trim();
                  if (fetchUrl.includes('/edit')) throw new Error("‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå Edit ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Publish to web > CSV)");
                  if (fetchUrl.includes('docs.google.com') && !fetchUrl.includes('/pub')) throw new Error("‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π 'Publish to web' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");

                  const response = await fetch(fetchUrl);
                  if (!response.ok) throw new Error("Network response was not ok (" + response.status + ")");
                  
                  const text = await response.text();
                  if (text.trim().toLowerCase().startsWith("<!doctype html") || text.trim().toLowerCase().startsWith("<html")) {
                      throw new Error("‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå HTML (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å format ‡πÄ‡∏õ‡πá‡∏ô CSV ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π Publish)");
                  }

                  const data = parseCSV(text);
                  if (data.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV");
                  
                  setBomData(data);
                  setIsUsingCloud(true);
                  setFileName("Cloud Data (Google Sheets)");

                  const hIndex = config ? config.headerRowIndex : headerRowIndex;
                  if (hIndex !== -1 && data.length > hIndex) {
                       setBomHeaders(data[hIndex]);
                       setIsBomConfigured(true);
                  } else {
                       // NEW: Auto-detect header for Cloud Data
                       const likelyHeader = data.findIndex(row => row.some(cell => { 
                           const t = String(cell).toLowerCase().replace(/[\n\r]/g, ''); 
                           return t.includes('part number') || t.includes('part no') || t === 'p/n'; 
                       }));
                       if (likelyHeader !== -1) {
                           selectHeaderRow(likelyHeader, data);
                       }
                  }
              } catch (error) {
                  console.error("Cloud Fetch Error:", error);
                  alert(t('syncError') + ": " + error.message);
                  setIsUsingCloud(false);
              } finally {
                  setIsSyncing(false);
              }
          };

          const saveConfig = () => {
              const config = {
                  headerRowIndex,
                  partNoColIndex,
                  partNameColIndex,
                  statusColIndex,
                  levelColIndex,
                  modelColumns,
                  cloudUrl 
              };
              try {
                localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(config));
                alert("Configuration Saved!");
                if (cloudUrl) fetchBOMFromCloud(cloudUrl);
              } catch (e) {
                alert("Save Config Failed: " + e.message);
              }
          };

          // --- Persistence Logic ---
          useEffect(() => {
              if (isAuthenticated) {
                  const savedConfig = localStorage.getItem(STORAGE_KEY_CONFIG);
                  if (savedConfig) {
                      const parsedConfig = JSON.parse(savedConfig);
                      setHeaderRowIndex(parsedConfig.headerRowIndex || -1);
                      setPartNoColIndex(parsedConfig.partNoColIndex || -1);
                      setPartNameColIndex(parsedConfig.partNameColIndex || -1);
                      setStatusColIndex(parsedConfig.statusColIndex || -1);
                      setLevelColIndex(parsedConfig.levelColIndex || -1);
                      setModelColumns(parsedConfig.modelColumns || {});
                      setCloudUrl(parsedConfig.cloudUrl || "");

                      if (parsedConfig.cloudUrl) {
                          fetchBOMFromCloud(parsedConfig.cloudUrl, parsedConfig);
                      }
                      if (userRole === 'user') {
                          setActiveTab('order');
                      }
                  }
              }
          }, [isAuthenticated, userRole]);

          // ... (Helper Functions) ...
          const parseCSV = (text) => {
            const arr = [];
            let quote = false;  
            for (let row = 0, col = 0, c = 0; c < text.length; c++) {
              let cc = text[c], nc = text[c+1]; 
              arr[row] = arr[row] || [];
              arr[row][col] = arr[row][col] || '';
              if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
              if (cc == '"') { quote = !quote; continue; }
              if (cc == ',' && !quote) { ++col; continue; }
              if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
              if (cc == '\n' && !quote) { ++row; col = 0; continue; }
              if (cc == '\r' && !quote) { ++row; col = 0; continue; }
              arr[row][col] += cc;
            }
            return arr.filter(r => r.length > 0 && r.some(c => c.trim().length > 0)).map(r => r.map(c => c.trim()));
          };
           const handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            setFileName(file.name);
            const reader = new FileReader();
            reader.onload = (evt) => {
              const text = evt.target.result;
              const data = parseCSV(text);
              setBomData(data);
              setIsBomConfigured(false);
              setIsUsingCloud(false); // Switched to local file
              setHeaderRowIndex(-1); setPartNoColIndex(-1); setPartNameColIndex(-1); setStatusColIndex(-1); setLevelColIndex(-1); setModelColumns({});
              const likelyHeader = data.findIndex(row => row.some(cell => { const t = cell.toLowerCase().replace(/[\n\r]/g, ''); return t.includes('part number') || t.includes('part no') || t === 'p/n'; }));
              if (likelyHeader !== -1) selectHeaderRow(likelyHeader, data);
            };
            reader.readAsText(file);
          };

          const toggleModelColumn = (index) => {
            setModelColumns(prev => {
              const next = { ...prev };
              if (next[index]) delete next[index]; else next[index] = bomHeaders[index];
              return next;
            });
          };

          const finishBomConfig = () => {
            if (partNoColIndex === -1) { alert(t('alertPartNo')); return; }
            if (Object.keys(modelColumns).length === 0) { alert(t('alertModel')); return; }
            setIsBomConfigured(true);
            setActiveTab('order');
          };

          const handleBulkOrderInput = (text) => {
            setOrderText(text);
            const lines = text.split('\n');
            const newOrders = [];
            lines.forEach(line => {
              const cleanedLine = line.trim();
              if (!cleanedLine) return;
              let model = '', qty = NaN;
              if (cleanedLine.includes('\t') || cleanedLine.includes(',')) {
                  const parts = cleanedLine.split(/[\t,]+/);
                  if (parts.length >= 2) {
                     const lastPart = parts[parts.length - 1].trim().replace(/,/g, ''); 
                     if (!isNaN(parseFloat(lastPart))) { qty = parseFloat(lastPart); model = parts.slice(0, parts.length - 1).join(' ').trim(); }
                  }
              }
              if (!model || isNaN(qty)) {
                  const match = cleanedLine.match(/^(.*?)[\s\t,]+(\d+(?:,\d+)*(?:\.\d+)?)$/);
                  if (match) { model = match[1].trim(); qty = parseFloat(match[2].replace(/,/g, '')); }
              }
              if (model && !isNaN(qty)) newOrders.push({ model, qty });
            });
            setOrders(newOrders);
          };

          const handleOrderFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (typeof XLSX === 'undefined') { alert("System resources are loading. Please try again in a few seconds."); return; }
            const reader = new FileReader();
            reader.onload = (evt) => {
              try {
                  const data = evt.target.result;
                  const workbook = XLSX.read(data, { type: 'array' });
                  const firstSheetName = workbook.SheetNames[0];
                  const worksheet = workbook.Sheets[firstSheetName];
                  const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                  const newOrders = [];
                  let modelIdx = 0, qtyIdx = 1, startRow = 0;
                  if (rows.length > 0) {
                      for (let r = 0; r < Math.min(rows.length, 5); r++) {
                          const rowStr = rows[r].map(c => String(c).toLowerCase());
                          const mIndex = rowStr.findIndex(c => c.includes('model') || c.includes('part') || c.includes('item') || c.includes('description') || c.includes('name'));
                          const qIndex = rowStr.findIndex(c => c.includes('qty') || c.includes('amount') || c.includes('quantity') || c.includes('count'));
                          if (mIndex !== -1 && qIndex !== -1) { modelIdx = mIndex; qtyIdx = qIndex; startRow = r + 1; break; }
                      }
                  }
                  for (let i = startRow; i < rows.length; i++) {
                      const row = rows[i];
                      if (!row || row.length <= modelIdx) continue;
                      let model = String(row[modelIdx] || "").trim();
                      let qtyVal = row[qtyIdx];
                      let qty = 0;
                      if (typeof qtyVal === 'number') qty = qtyVal;
                      else if (typeof qtyVal === 'string') qty = parseFloat(qtyVal.replace(/,/g, ''));
                      if (model && !isNaN(qty) && qty > 0) newOrders.push({ model, qty });
                  }
                  if (newOrders.length > 0) { setOrders(newOrders); setOrderText(newOrders.map(o => `${o.model}\t${o.qty}`).join('\n')); }
                  else alert(t('readError') + "No valid orders found. (Format: Col A=Model, Col B=Qty)");
              } catch (err) { console.error(err); alert(t('readError') + err.message); }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = null; 
          };
          const editDistance = (s1, s2) => { s1 = s1.toLowerCase(); s2 = s2.toLowerCase(); const costs = new Array(); for (let i = 0; i <= s1.length; i++) { let lastValue = i; for (let j = 0; j <= s2.length; j++) { if (i == 0) costs[j] = j; else { if (j > 0) { let newValue = costs[j - 1]; if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1; costs[j - 1] = lastValue; lastValue = newValue; } } } if (i > 0) costs[s2.length] = lastValue; } return costs[s2.length]; }
          const getSimilarity = (s1, s2) => { let longer = s1.toLowerCase(); let shorter = s2.toLowerCase(); if (s1.length < s2.length) { longer = s2.toLowerCase(); shorter = s1.toLowerCase(); } const longerLength = longer.length; if (longerLength === 0) return 1.0; return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength); }
          const findClosestMatch = (inputModel, availableModels) => { const parseModel = (str) => { const match = str.match(/^(.*?)(\d+)$/); return match ? { prefix: match[1], num: parseInt(match[2]), full: str } : { prefix: str, num: null, full: str }; }; const inputParsed = parseModel(inputModel.trim()); if (inputParsed.num !== null) { let bestNumericMatch = null, minDiff = Infinity; availableModels.forEach(model => { const targetParsed = parseModel(model); if (targetParsed.num !== null) { const textSim = getSimilarity(inputParsed.prefix, targetParsed.prefix); if (textSim > 0.9) { const diff = Math.abs(inputParsed.num - targetParsed.num); if (diff < minDiff) { minDiff = diff; bestNumericMatch = model; } } } }); if (bestNumericMatch) return bestNumericMatch; } let bestMatch = null, bestScore = 0; availableModels.forEach(model => { let score = 0; if (model.includes(inputModel) || inputModel.includes(model)) score = 0.85; else score = getSimilarity(inputModel, model); if (score > bestScore && score >= 0.4) { bestScore = score; bestMatch = model; } }); return bestMatch; };
          const preCalculateValidation = () => { const availableModels = Object.values(modelColumns); const valid = [], missing = [], queue = []; const modelColMap = {}; Object.entries(modelColumns).forEach(([idx, name]) => { modelColMap[name.trim()] = parseInt(idx); const cleanName = name.trim().replace(/\*$/, ''); if (cleanName !== name.trim()) modelColMap[cleanName] = parseInt(idx); }); orders.forEach(order => { let matchedModelKey = Object.keys(modelColMap).find(m => m === order.model); if (!matchedModelKey) matchedModelKey = Object.keys(modelColMap).find(m => m.includes(order.model) || order.model.includes(m)); if (matchedModelKey) valid.push({ ...order, model: matchedModelKey }); else { const candidate = findClosestMatch(order.model, Object.keys(modelColMap)); if (candidate) queue.push({ original: order.model, candidate: candidate, qty: order.qty }); else missing.push(order.model); } }); setVerifiedOrders(valid); setTempMissing(missing); setResolveQueue(queue); if (queue.length > 0) setShowResolveModal(true); else performCalculation(valid, missing); };
          const handleResolve = (index, accept) => { const item = resolveQueue[index]; if (accept) setVerifiedOrders(prev => [...prev, { model: item.candidate, qty: item.qty }]); else setTempMissing(prev => [...prev, item.original]); const newQueue = [...resolveQueue]; newQueue.splice(index, 1); setResolveQueue(newQueue); if (newQueue.length === 0) { setShowResolveModal(false); const finalValid = accept ? [...verifiedOrders, { model: item.candidate, qty: item.qty }] : verifiedOrders; const finalMissing = accept ? tempMissing : [...tempMissing, item.original]; performCalculation(finalValid, finalMissing); } };
          const performCalculation = (finalOrders, finalMissing) => { try { const requirements = {}, modelColMap = {}; const rowParents = {}, levelStack = {}; if (levelColIndex !== -1 && partNameColIndex !== -1) { for (let r = headerRowIndex + 1; r < bomData.length; r++) { const row = bomData[r]; if (!row || row.length <= levelColIndex) continue; const lvlRaw = row[levelColIndex] || "", lvlClean = parseInt(lvlRaw.replace(/[^0-9]/g, '')); if (!isNaN(lvlClean)) { const partName = row[partNameColIndex] || "Unknown"; levelStack[lvlClean] = partName; if (lvlClean > 1) rowParents[r] = levelStack[lvlClean - 1] || "-"; else rowParents[r] = "-"; } } } Object.entries(modelColumns).forEach(([idx, name]) => { const cleanName = name.trim().replace(/\*$/, ''); modelColMap[name.trim()] = parseInt(idx); if (cleanName !== name.trim()) modelColMap[cleanName] = parseInt(idx); }); finalOrders.forEach(order => { let matchedModelKey = Object.keys(modelColMap).find(m => m === order.model); if (!matchedModelKey) matchedModelKey = Object.keys(modelColMap).find(m => m.includes(order.model) || order.model.includes(m)); if (!matchedModelKey) return; const colIndex = modelColMap[matchedModelKey]; const orderPartUsage = {}; for (let i = headerRowIndex + 1; i < bomData.length; i++) { const row = bomData[i]; if (!row || row.length <= partNoColIndex) continue; const partNo = row[partNoColIndex], partName = (partNameColIndex !== -1 && row[partNameColIndex]) ? row[partNameColIndex] : ''; const isPlaceholder = !partNo || ['new', 'n/a', '-', 'null'].includes(String(partNo).trim().toLowerCase()); const effectivePartNo = isPlaceholder ? (partNo || "New") : partNo; const statusRaw = (statusColIndex !== -1 && row[statusColIndex]) ? row[statusColIndex] : 'Unknown'; const status = String(statusRaw).trim(); let displayLevel = "-", depth = 0; if (levelColIndex !== -1 && row[levelColIndex]) { const lvlRaw = row[levelColIndex], lvlClean = parseInt(lvlRaw.replace(/[^0-9]/g, '')); if (!isNaN(lvlClean)) { depth = lvlClean - 1; displayLevel = (lvlClean === 1) ? "1" : ".".repeat(lvlClean) + lvlClean; } } const qtyStr = (colIndex < row.length) ? row[colIndex] : null; let qtyPerUnit = 0; if (qtyStr) { const val = parseFloat(String(qtyStr).replace(/,/g, '')); if (!isNaN(val)) qtyPerUnit = val; } if (qtyPerUnit >= 0) { let key = effectivePartNo; if (isPlaceholder) key = `${effectivePartNo}__|__${partName}`; if (!orderPartUsage[key]) orderPartUsage[key] = { perUnit: 0, rowInfo: { partNo: effectivePartNo, partName, status, level: displayLevel, depth, rowIndex: i }, parents: new Set() }; orderPartUsage[key].perUnit += qtyPerUnit; if (rowParents[i] && rowParents[i] !== "-") orderPartUsage[key].parents.add(rowParents[i]); } } Object.entries(orderPartUsage).forEach(([key, usage]) => { const { perUnit, rowInfo, parents } = usage, totalForOrder = perUnit * order.qty; if (!requirements[key]) requirements[key] = { ...rowInfo, parents: new Set(), totalQty: 0, breakdown: [] }; else requirements[key].rowIndex = Math.min(requirements[key].rowIndex, rowInfo.rowIndex); if (parents) parents.forEach(p => requirements[key].parents.add(p)); requirements[key].totalQty += totalForOrder; requirements[key].breakdown.push({ model: order.model, orderQty: order.qty, perUnit: perUnit, total: totalForOrder }); }); }); setMissingModels([...new Set(finalMissing)]); const validReqs = Object.values(requirements).filter(r => r.totalQty > 0); setCalculationResult(validReqs); setActiveTab('result'); } catch (err) { console.error("Calculation Error:", err); alert(t('calcError') + ": " + err.message); } };
          const getFilteredResults = () => { if (!calculationResult) return []; let filtered = calculationResult.filter(item => { if (filterType === 'all') return true; const s = item.status.toLowerCase(); if (filterType === 'new') return s.includes('new'); if (filterType === 'reuse') return s.includes('reuse'); return true; }); if (sortType === 'structure') return filtered.sort((a, b) => a.rowIndex - b.rowIndex); else return filtered.sort((a, b) => b.totalQty - a.totalQty); };
          const exportToCSV = () => { const dataToExport = getFilteredResults(); if (dataToExport.length === 0) return; let csvContent = `\uFEFF${t('colPartNo')},${t('colDesc')},${t('colLevel')},${t('colParent')},${t('colStatus')},${t('colQty')}\n`; dataToExport.forEach(item => { const safePartName = item.partName ? item.partName.replace(/"/g, '""') : ""; const safeLevel = item.level ? item.level.toString().replace(/"/g, '""') : ""; const parentStr = Array.from(item.parents).join(' / ').replace(/"/g, '""'); csvContent += `"${item.partNo}","${safePartName}","${safeLevel}","${parentStr}","${item.status}",${item.totalQty}\n`; }); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.setAttribute('href', url); link.setAttribute('download', `NLC_MRP_${filterType.toUpperCase()}_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
          const handlePrint = () => { const data = getFilteredResults(); if (data.length === 0) return; const printWindow = window.open('', '_blank', 'width=900,height=700'); if (!printWindow) { alert("Pop-up blocked! Please allow pop-ups."); return; } const htmlContent = `<!DOCTYPE html><html><head><title>${t('appTitle')}</title><style>body { font-family: 'Sarabun', sans-serif; padding: 20px; color: #333; } h1 { text-align: center; font-size: 24px; color: #1e3a8a; } table { width: 100%; border-collapse: collapse; font-size: 12px; } th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; vertical-align: top; } th { background-color: #f1f5f9; } .text-right { text-align: right; } .text-center { text-align: center; } .status-new { color: #2563eb; font-weight: bold; background: #eff6ff; padding: 2px 6px; border-radius: 4px; } .status-reuse { color: #d97706; font-weight: bold; background: #fff7ed; padding: 2px 6px; border-radius: 4px; } @media print { @page { margin: 1.5cm; size: A4; } body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }</style></head><body><h1>${t('resultTitle')}</h1><table><thead><tr><th class="text-center">${t('colNo')}</th><th>${t('colPartNo')}</th><th>${t('colDesc')}</th><th class="text-left">${t('colLevel')}</th><th class="text-center">${t('colStatus')}</th><th class="text-right">${t('colQty')}</th></tr></thead><tbody>${data.map((item, index) => `<tr><td class="text-center">${index + 1}</td><td style="font-family: monospace;">${item.partNo}</td><td style="padding-left: ${item.depth ? item.depth * 20 + 8 : 12}px;">${item.partName || '-'}</td><td class="text-left">${item.level || '-'}</td><td class="text-center"><span class="${item.status.toLowerCase().includes('new') ? 'status-new' : item.status.toLowerCase().includes('reuse') ? 'status-reuse' : ''}">${item.status}</span></td><td class="text-right"><strong>${item.totalQty.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 })}</strong></td></tr>`).join('')}</tbody></table><script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }<\/script></body></html>`; printWindow.document.open(); printWindow.document.write(htmlContent); printWindow.document.close(); };

          // --- LOGIN SCREEN ---
          if (!isAuthenticated) {
              return (
                  <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                      <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center animate-fade-in">
                          <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                              <Icons.Lock className="w-8 h-8 text-blue-600" />
                          </div>
                          <h1 className="text-2xl font-bold text-slate-800 mb-1">{t('appTitle')}</h1>
                          <p className="text-slate-500 text-sm mb-6">{t('loginTitle')}</p>
                          <form onSubmit={handleLogin} className="space-y-4">
                              <div>
                                  <input type="password" inputMode="numeric" pattern="[0-9]*" value={inputPassword} onChange={(e) => setInputPassword(e.target.value)} placeholder={t('passwordPlaceholder')} className="w-full text-center text-xl tracking-widest p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" autoFocus />
                              </div>
                              {loginError && <div className="text-red-500 text-sm font-bold animate-pulse">{t('loginError')}</div>}
                              <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700 active:scale-95 transition">{t('loginButton')}</button>
                          </form>
                          <div className="mt-6 flex justify-center gap-2">
                             <button onClick={() => setLang('th')} className={`text-xs px-2 py-1 rounded ${lang === 'th' ? 'bg-slate-200 font-bold' : 'text-slate-400'}`}>TH</button>
                             <button onClick={() => setLang('en')} className={`text-xs px-2 py-1 rounded ${lang === 'en' ? 'bg-slate-200 font-bold' : 'text-slate-400'}`}>EN</button>
                          </div>
                      </div>
                  </div>
              );
          }

          return (
            <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-10">
              {/* Header */}
              <header className="bg-blue-900 text-white p-3 shadow-md sticky top-0 z-50">
                <div className="container mx-auto flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Icons.Database className="h-6 w-6" />
                    <div>
                        <h1 className="text-lg font-bold leading-tight">{t('appTitle')}</h1>
                        <div className="text-[10px] opacity-80 hidden sm:block">{t('subtitle')}</div>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                      <div className="hidden md:flex items-center bg-blue-800 px-2 py-1 rounded text-xs gap-1">
                          {userRole === 'admin' ? <Icons.Shield className="w-3 h-3 text-yellow-300"/> : <Icons.User className="w-3 h-3 text-blue-300"/>}
                          <span className="font-bold text-white">{userRole === 'admin' ? t('roleAdmin') : t('roleUser')}</span>
                      </div>
                      <div className="flex items-center gap-1 bg-blue-800 rounded p-1">
                          <button onClick={() => setLang('th')} className={`px-2 py-1 text-xs rounded ${lang === 'th' ? 'bg-white text-blue-900 font-bold' : 'text-blue-200'}`}>TH</button>
                          <button onClick={() => setLang('en')} className={`px-2 py-1 text-xs rounded ${lang === 'en' ? 'bg-white text-blue-900 font-bold' : 'text-blue-200'}`}>EN</button>
                      </div>
                      <button onClick={handleLogout} className="text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded flex items-center gap-1"><Icons.LogOut className="w-3 h-3" /></button>
                  </div>
                </div>
              </header>

              <main className="container mx-auto p-2 md:p-4 pb-20 relative">
                {/* Modals & Popups */}
                {breakdownItem && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in" onClick={() => setBreakdownItem(null)}>
                        <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden" onClick={e => e.stopPropagation()}>
                            <div className="bg-blue-600 text-white p-3 flex justify-between items-center shrink-0"><h3 className="text-base font-bold flex items-center gap-2 truncate pr-2"><Icons.Info className="w-5 h-5 shrink-0" /> {t('breakdownTitle').replace('{partNo}', breakdownItem.partNo)}</h3><button onClick={() => setBreakdownItem(null)} className="text-white text-xl px-2">&times;</button></div>
                            <div className="bg-orange-50 px-3 py-2 text-xs text-orange-800 border-b flex gap-3 shrink-0"><span className="flex items-center gap-1"><span className="w-2 h-2 bg-red-100 border border-red-300 inline-block"></span> {t('legendRed')}</span><span className="flex items-center gap-1"><span className="w-2 h-2 bg-white border border-gray-300 inline-block"></span> {t('legendNormal')}</span></div>
                            <div className="flex-1 overflow-y-auto p-0 smooth-scroll"><table className="w-full text-xs text-left"><thead className="bg-slate-100 text-slate-600 font-semibold sticky top-0 shadow-sm"><tr><th className="p-2 border-b">{t('breakdownColModel')}</th><th className="p-2 border-b text-right">{t('breakdownColOrder')}</th><th className="p-2 border-b text-right">{t('breakdownColPerUnit')}</th><th className="p-2 border-b text-right">{t('breakdownColTotal')}</th></tr></thead><tbody className="divide-y divide-slate-100">{breakdownItem.breakdown.map((b, i) => (<tr key={i} className={`hover:bg-blue-50 ${b.total === 0 ? 'bg-red-50 text-red-600' : ''}`}><td className="p-2 font-medium">{b.model}</td><td className="p-2 text-right">{b.orderQty.toLocaleString()}</td><td className="p-2 text-right">{b.perUnit}</td><td className="p-2 text-right font-bold">{b.total.toLocaleString()}</td></tr>))}</tbody></table></div>
                            <div className="p-3 border-t bg-gray-50 text-right shrink-0"><div className="text-xs text-slate-500 mb-1">Total: <strong>{breakdownItem.totalQty.toLocaleString()}</strong></div><button onClick={() => setBreakdownItem(null)} className="w-full px-4 py-2 bg-slate-500 text-white rounded text-sm hover:bg-slate-600">{t('close')}</button></div>
                        </div>
                    </div>
                )}
                {showResolveModal && resolveQueue.length > 0 && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
                        <div className="bg-white rounded-lg shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                            <div className="bg-orange-500 text-white p-3 flex items-center gap-2 sticky top-0 z-10"><Icons.Search className="w-5 h-5" /><h3 className="text-base font-bold">{t('modalTitle')}</h3></div>
                            <div className="p-4"><p className="text-sm text-gray-600 mb-4">{t('modalDesc')}</p><div className="bg-orange-50 border border-orange-200 rounded p-3 mb-4 flex flex-col sm:flex-row items-center justify-between gap-2"><div className="text-center flex-1 w-full"><div className="text-xs text-gray-500">{t('modalOriginal')}</div><div className="text-base font-bold text-red-600 line-through decoration-2 decoration-red-400 break-all">{resolveQueue[0].original}</div></div><div className="text-xl text-gray-400 rotate-90 sm:rotate-0">&rarr;</div><div className="text-center flex-1 w-full"><div className="text-xs text-gray-500">{t('modalCandidate')}</div><div className="text-base font-bold text-green-700 break-all">{resolveQueue[0].candidate}</div></div></div><div className="flex gap-2"><button onClick={() => handleResolve(0, false)} className="flex-1 px-3 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold transition text-sm">{t('btnSkip')}</button><button onClick={() => handleResolve(0, true)} className="flex-1 px-3 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow transition text-sm">{t('btnUse')}</button></div></div>
                        </div>
                    </div>
                )}
                
                {/* Loading Modal */}
                {isSyncing && (
                    <div className="fixed inset-0 z-[60] flex flex-col items-center justify-center p-4 modal-overlay backdrop-blur-sm">
                        <div className="bg-white p-6 rounded-xl shadow-xl flex flex-col items-center animate-bounce-in">
                            <div className="loading-spinner mb-4"></div>
                            <p className="font-bold text-slate-700">{t('syncing')}</p>
                        </div>
                    </div>
                )}

                {/* Stepper */}
                <div className="flex justify-center mb-4 text-xs md:text-sm">
                    {userRole === 'admin' ? (
                        <button onClick={() => setActiveTab('bom')} className={`flex-1 sm:flex-none px-3 py-2 rounded-l-lg border text-center ${activeTab === 'bom' ? 'bg-blue-100 border-blue-500 text-blue-700 font-bold' : 'bg-white border-slate-300'}`}>{t('step1')}</button>
                    ) : (<div className={`flex-1 sm:flex-none px-3 py-2 rounded-l-lg border text-center bg-gray-100 text-gray-400 cursor-not-allowed`}>{t('step1')}</div>)}
                    <button disabled={!isBomConfigured} onClick={() => setActiveTab('order')} className={`flex-1 sm:flex-none px-3 py-2 border-t border-b border-r text-center ${activeTab === 'order' ? 'bg-blue-100 border-blue-500 text-blue-700 font-bold' : 'bg-white border-slate-300 disabled:opacity-50'}`}>{t('step2')}</button>
                    <button disabled={!calculationResult} onClick={() => setActiveTab('result')} className={`flex-1 sm:flex-none px-3 py-2 rounded-r-lg border-t border-b border-r text-center ${activeTab === 'result' ? 'bg-blue-100 border-blue-500 text-blue-700 font-bold' : 'bg-white border-slate-300 disabled:opacity-50'}`}>{t('step3')}</button>
                </div>

                {/* TAB 1: BOM Config (Admin) */}
                {activeTab === 'bom' && (
                  <div className="bg-white rounded-lg shadow p-3 md:p-6 animate-fade-in relative">
                    {userRole !== 'admin' && (
                        <div className="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center text-center p-4">
                            <Icons.Lock className="w-12 h-12 text-slate-300 mb-2"/>
                            <h3 className="text-slate-500 font-bold">{t('adminOnly')}</h3>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-3">
                        <h2 className="text-base font-semibold flex items-center gap-2">
                            <Icons.FileSpreadsheet className="text-green-600 w-5 h-5" /> 
                            {bomData.length > 0 ? `${t('configTitle')} (${isUsingCloud ? 'Cloud' : 'Local'})` : t('uploadTitle')}
                        </h2>
                        {userRole === 'admin' && isBomConfigured && (
                             <button onClick={saveConfig} className="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1">
                                <Icons.Save className="w-3 h-3"/> {t('saveConfig')}
                            </button>
                        )}
                    </div>
                    
                    {/* Cloud Sync Section */}
                    <div className="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div className="flex items-center gap-2 mb-2">
                            <Icons.Cloud className="w-5 h-5 text-indigo-600" />
                            <span className="font-bold text-indigo-800 text-sm">{t('cloudSection')}</span>
                        </div>
                        <p className="text-xs text-indigo-600 mb-2">{t('cloudHint')}</p>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={cloudUrl}
                                onChange={(e) => setCloudUrl(e.target.value)}
                                placeholder={t('pasteLink')}
                                className="flex-1 text-sm p-2 border border-indigo-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"
                            />
                            <button 
                                onClick={() => { saveConfig(); fetchBOMFromCloud(cloudUrl); }}
                                className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-xs font-bold whitespace-nowrap"
                            >
                                {t('saveCloud')}
                            </button>
                        </div>
                    </div>

                    {!bomData.length ? (
                      <div className="border-2 border-dashed border-slate-300 rounded-xl p-6 md:p-10 text-center hover:bg-slate-50 transition group cursor-pointer relative">
                        <Icons.Upload className="mx-auto h-10 w-10 text-slate-400 mb-2 group-hover:text-blue-500 transition-colors" />
                        <p className="text-slate-600 text-sm mb-2">{t('dropZone')}</p>
                        <input type="file" accept=".csv, .txt" onChange={handleFileUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                      </div>
                    ) : (
                      <div className="space-y-4">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-blue-50 p-2 rounded border border-blue-100 gap-2">
                           <span className="text-xs text-blue-800 leading-relaxed" dangerouslySetInnerHTML={{__html: t('instruction')}}></span>
                           <div className="flex gap-2 self-end sm:self-auto">
                                <span className={`text-xs px-2 py-1 rounded border ${isUsingCloud ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-orange-100 text-orange-700 border-orange-200'}`}>
                                    {isUsingCloud ? t('usingCloud') : t('usingLocal')}
                                </span>
                                <button onClick={() => { setBomData([]); setIsBomConfigured(false); }} className="text-xs text-white bg-slate-500 hover:bg-slate-600 px-3 py-1.5 rounded flex items-center gap-1">
                                    <Icons.RefreshCw className="w-3 h-3"/> {t('reload')}
                                </button>
                           </div>
                        </div>
                        
                        {/* Table Render */}
                        <div className="overflow-auto border rounded max-h-[50vh] shadow-inner bg-slate-100 smooth-scroll">
                          <table className="w-full text-xs text-left border-collapse">
                            <thead className="sticky top-0 z-20 shadow-sm">
                                {headerRowIndex !== -1 && (
                                     <tr>
                                        <th className="bg-white p-2 border-b w-8"></th>
                                        {bomData[headerRowIndex].map((h, i) => (
                                            <th key={i} className="p-1 text-center bg-slate-50 border-b border-r min-w-[90px]">
                                                <div className="flex flex-col gap-1 items-center">
                                                    <div className="h-4 flex gap-1 justify-center">
                                                        {i === partNoColIndex && <span className="bg-red-500 text-white text-[9px] px-1 rounded">P#</span>}
                                                        {i === partNameColIndex && <span className="bg-orange-400 text-white text-[9px] px-1 rounded">Name</span>}
                                                        {i === statusColIndex && <span className="bg-yellow-400 text-white text-[9px] px-1 rounded border border-yellow-500">St</span>}
                                                        {i === levelColIndex && <span className="bg-purple-500 text-white text-[9px] px-1 rounded">Lv</span>}
                                                        {modelColumns[i] && <span className="bg-green-500 text-white text-[9px] px-1 rounded">Md</span>}
                                                    </div>
                                                    <div className="flex flex-wrap gap-1 justify-center max-w-[110px]">
                                                        <button onClick={() => setPartNoColIndex(i)} className={`text-[10px] px-2 py-1 border rounded ${i === partNoColIndex ? 'bg-red-100 border-red-500 font-bold' : 'bg-white'}`}>P#</button>
                                                        <button onClick={() => setPartNameColIndex(i)} className={`text-[10px] px-2 py-1 border rounded ${i === partNameColIndex ? 'bg-orange-100 border-orange-400 font-bold' : 'bg-white'}`}>Name</button>
                                                        <button onClick={() => toggleModelColumn(i)} className={`text-[10px] px-2 py-1 border rounded ${modelColumns[i] ? 'bg-green-100 border-green-500 font-bold' : 'bg-white'}`}>Model</button>
                                                        <div className="flex gap-1">
                                                            <button onClick={() => setStatusColIndex(i)} className={`text-[9px] px-1 py-1 border rounded ${i === statusColIndex ? 'bg-yellow-100 border-yellow-400' : 'bg-white text-gray-400'}`}>Stat</button>
                                                            <button onClick={() => setLevelColIndex(i)} className={`text-[9px] px-1 py-1 border rounded ${i === levelColIndex ? 'bg-purple-100 border-purple-500' : 'bg-white text-gray-400'}`}>Lvl</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </th>
                                        ))}
                                     </tr>
                                )}
                            </thead>
                            <tbody>
                              {bomData.slice(0, 50).map((row, rIndex) => (
                                <tr key={rIndex} onClick={() => headerRowIndex === -1 && selectHeaderRow(rIndex)} className={`border-b transition-colors ${rIndex === headerRowIndex ? 'bg-slate-800 text-white font-bold' : 'bg-white hover:bg-blue-50'} ${headerRowIndex !== -1 && rIndex < headerRowIndex ? 'opacity-40 bg-slate-100 grayscale' : ''}`}>
                                  <td className="p-2 border-r bg-slate-50 text-center text-[10px] text-slate-400">{rIndex + 1}</td>
                                  {row.map((cell, cIndex) => (
                                    <td key={cIndex} className={`p-2 border-r min-w-[100px] max-w-[200px] whitespace-normal break-words ${cIndex === partNoColIndex && rIndex > headerRowIndex ? 'bg-red-50 text-red-900 font-mono text-xs' : ''} ${cIndex === statusColIndex && rIndex > headerRowIndex ? 'bg-yellow-50 text-yellow-900 text-center font-bold' : ''} ${cIndex === levelColIndex && rIndex > headerRowIndex ? 'bg-purple-50 text-purple-900 text-center' : ''} ${modelColumns[cIndex] && rIndex > headerRowIndex ? 'bg-green-50 text-green-900 text-center' : ''}`}>{cell}</td>
                                  ))}
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                        <div className="flex justify-end pt-4 border-t sticky bottom-0 bg-white p-2">
                            <button onClick={finishBomConfig} disabled={partNoColIndex === -1 || Object.keys(modelColumns).length === 0} className="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white rounded shadow hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-medium">{t('next')} <Icons.Settings className="w-4 h-4"/></button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* TAB 2 & 3: Order & Result (Same Logic) */}
                {activeTab === 'order' && (
                  <div className="bg-white rounded-lg shadow p-4 animate-fade-in max-w-4xl mx-auto">
                     <h2 className="text-base font-semibold mb-4 flex items-center gap-2"><Icons.Calculator className="text-blue-600 w-5 h-5" /> {t('inputOrderTitle')}</h2>
                    <div className="flex flex-col gap-6">
                        <div>
                            <div className="mb-4 p-4 border-2 border-dashed border-blue-200 rounded-lg bg-blue-50 flex flex-col items-center justify-center text-center relative group active:bg-blue-100 transition"><input type="file" accept=".xlsx, .xls, .csv" onChange={handleOrderFileUpload} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" /><Icons.FileSpreadsheet className="w-8 h-8 text-blue-500 mb-2" /><span className="text-blue-700 font-bold text-sm">{t('importOrderTitle')}</span><span className="text-blue-500 text-xs">{t('importOrderHint')}</span></div>
                            <div className="text-center text-slate-400 text-xs my-2">- {t('or')} -</div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">{t('copyPasteLabel')}</label><textarea className="w-full h-32 p-3 border rounded font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" placeholder={t('placeholder')} value={orderText} onChange={(e) => handleBulkOrderInput(e.target.value)}></textarea><p className="text-[10px] text-slate-500 mt-1">{t('inputHint')}</p>
                        </div>
                        <div className="flex flex-col h-full"><div className="flex justify-between items-center mb-2"><span className="text-sm font-medium text-slate-700">{t('itemList')} ({orders.length})</span><button onClick={() => { setOrderText(''); setOrders([]); }} className="text-xs text-red-500 hover:text-red-700 px-2 py-1 bg-red-50 rounded">{t('clear')}</button></div><div className="max-h-[200px] overflow-y-auto border rounded bg-slate-50 p-0 relative smooth-scroll">{orders.length === 0 ? (<div className="flex items-center justify-center text-slate-400 text-sm p-8 text-center">{t('noData')}</div>) : (<table className="w-full text-sm"><thead className="text-xs text-slate-500 border-b bg-slate-100 sticky top-0"><tr><th className="text-left p-2">Model</th><th className="text-right p-2">Qty</th></tr></thead><tbody>{orders.map((o, i) => (<tr key={i} className="border-b border-slate-200 last:border-0 bg-white"><td className="p-2 font-medium text-blue-800 font-mono text-xs truncate max-w-[150px]">{o.model}</td><td className="p-2 text-right">{o.qty.toLocaleString()}</td></tr>))}</tbody></table>)}</div></div>
                    </div>
                    <div className="flex gap-2 mt-6 pt-4 border-t sticky bottom-0 bg-white">
                         <button onClick={() => setActiveTab('bom')} className="flex-1 text-slate-600 bg-slate-100 hover:bg-slate-200 px-4 py-3 rounded text-sm font-bold">&larr; {t('back')}</button>
                         <button onClick={preCalculateValidation} disabled={orders.length === 0} className="flex-[2] px-4 py-3 bg-green-600 text-white rounded shadow-lg hover:bg-green-700 disabled:bg-slate-300 flex items-center justify-center gap-2 font-bold"><Icons.Calculator className="w-5 h-5" /> {t('calculate')}</button>
                    </div>
                  </div>
                )}
                {activeTab === 'result' && calculationResult && (
                     <div className="bg-white rounded-lg shadow p-3 md:p-6 animate-fade-in">
                        <div className="flex flex-col gap-4 mb-4">
                            <div><h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icons.CheckCircle className="text-green-500 w-5 h-5" /> {t('resultTitle')}</h2><p className="text-slate-500 text-xs mt-1">{t('orderSummary').replace('{models}', orders.length).replace('{units}', orders.reduce((a,b)=>a+b.qty,0).toLocaleString())}</p></div>
                            <div className="flex flex-col gap-3">
                                <div className="flex flex-wrap gap-2 justify-between items-center bg-slate-50 p-2 rounded">
                                    <div className="flex items-center gap-2 text-xs text-slate-500"><span className="font-bold flex items-center gap-1"><Icons.Sort className="w-3 h-3" /> {t('sortBy')}</span><button onClick={() => setSortType('structure')} className={`px-2 py-1 rounded border ${sortType === 'structure' ? 'bg-blue-100 border-blue-300 text-blue-700' : 'bg-white'}`}>{t('sortStructure')}</button><button onClick={() => setSortType('qty')} className={`px-2 py-1 rounded border ${sortType === 'qty' ? 'bg-blue-100 border-blue-300 text-blue-700' : 'bg-white'}`}>{t('sortQty')}</button></div>
                                    <div className="flex bg-white rounded-md border border-slate-200 overflow-hidden"><button onClick={() => setFilterType('all')} className={`px-3 py-1 text-xs transition-all ${filterType === 'all' ? 'bg-slate-100 text-blue-700 font-bold' : 'text-slate-500'}`}>{t('showAll')}</button><div className="w-[1px] bg-slate-200"></div><button onClick={() => setFilterType('new')} className={`px-3 py-1 text-xs transition-all ${filterType === 'new' ? 'bg-blue-500 text-white font-bold' : 'text-slate-500'}`}>{t('onlyNew')}</button><div className="w-[1px] bg-slate-200"></div><button onClick={() => setFilterType('reuse')} className={`px-3 py-1 text-xs transition-all ${filterType === 'reuse' ? 'bg-orange-500 text-white font-bold' : 'text-slate-500'}`}>{t('onlyReuse')}</button></div>
                                </div>
                                <div className="flex gap-2 w-full"><button onClick={handlePrint} className="flex-1 px-3 py-2 bg-slate-700 text-white rounded shadow text-xs flex items-center justify-center gap-2"><Icons.Printer className="w-4 h-4" /> {t('print')}</button><button onClick={exportToCSV} className="flex-1 px-3 py-2 bg-green-600 text-white rounded shadow text-xs flex items-center justify-center gap-2"><Icons.Download className="w-4 h-4" /> {t('export')}</button></div>
                            </div>
                        </div>
                        {missingModels.length > 0 && (<div className="mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-800 text-xs"><div className="font-bold flex items-center gap-2 mb-2"><Icons.AlertCircle className="w-4 h-4" /> {t('missingModel')} ({missingModels.length}):</div><div className="flex flex-wrap gap-2 max-h-24 overflow-y-auto">{missingModels.map(m => (<span key={m} className="px-2 py-1 bg-white border border-red-200 rounded font-mono">{m}</span>))}</div></div>)}
                        <div className="overflow-x-auto rounded border shadow-sm smooth-scroll"><table className="w-full text-sm text-left whitespace-nowrap"><thead className="bg-slate-100 text-slate-600 font-semibold uppercase text-xs sticky top-0"><tr><th className="p-2 border-b w-8 text-center">{t('colNo')}</th><th className="p-2 border-b">{t('colPartNo')}</th><th className="p-2 border-b">{t('colDesc')}</th><th className="p-2 border-b text-center w-16">{t('colLevel')}</th><th className="p-2 border-b text-center w-16">{t('colStatus')}</th><th className="p-2 border-b text-right">{t('colQty')}</th></tr></thead><tbody className="divide-y divide-slate-100 bg-white">{getFilteredResults().map((item, index) => (<tr key={index} className="hover:bg-blue-50 transition-colors" onClick={() => setBreakdownItem(item)}><td className="p-2 text-center text-slate-400 text-xs">{index + 1}</td><td className="p-2 font-mono text-blue-700 font-medium text-xs">{item.partNo}</td><td className="p-2 text-slate-700 text-xs truncate max-w-[150px]"><div style={{ paddingLeft: item.depth && sortType === 'structure' ? `${item.depth * 10}px` : '0px' }}>{item.depth > 0 && sortType === 'structure' && <span className="text-slate-300 mr-1">‚Ü≥</span>}{item.partName || '-'}</div></td><td className="p-2 text-center text-slate-500 font-mono text-xs">{item.level}</td><td className="p-2 text-center"><span className={`px-1.5 py-0.5 rounded text-[10px] font-bold border ${item.status.toLowerCase().includes('new') ? 'bg-blue-100 text-blue-700 border-blue-200' : item.status.toLowerCase().includes('reuse') ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-gray-100'}`}>{item.status.substring(0, 1).toUpperCase() + item.status.substring(1)}</span></td><td className="p-2 text-right font-bold text-slate-800">{item.totalQty.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 })}</td></tr>))}</tbody></table></div>
                     </div>
                )}
              </main>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>